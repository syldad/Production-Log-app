<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Production Log v14.3 (fixed)</title>

    <!-- PWA / Full-Screen Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F97316">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FFF8F0; }
        .modal { transition: opacity 0.3s ease; }
        .details-row { display: none; }
        .summary-row { cursor: pointer; transition: background-color 0.2s; }
        .summary-row:hover { background-color: #FFFAF0; }
        .summary-row.expanded { background-color: #FFEAD9; }
        .summary-row.shito:hover { background-color: #FFF5F5; }
        .summary-row.shito.expanded { background-color: #FFEBEE; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #FB923C; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .export-card { background-color: white; padding: 1.5rem; border: 1px solid #ddd; font-family: 'Inter', sans-serif; width: 600px; color: #333; }
        #export-preview-modal img { max-width: 90vw; max-height: 70vh; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: auto; opacity: 1; }
        .page { display: none; }
        #alert-modal { transition: opacity 0.2s ease; }
    </style>
</head>
<body class="text-gray-800">

    <!-- === HOME PAGE === -->
    <div id="page-home" class="page container mx-auto p-4 max-w-xl text-center" style="display: block;">
        <header class="bg-white shadow-lg rounded-xl p-6 mb-8 border-t-4 border-orange-500">
            <h1 class="text-3xl font-bold text-orange-800">Production Log</h1>
            <p class="text-gray-500">Select a process to begin</p>
        </header>
        <div class="grid grid-cols-1 gap-6">
            <button onclick="requestAccess('slurry')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-6 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <span class="text-2xl">Add New Slurry Batch</span>
            </button>
            <button onclick="requestAccess('shitoMenu')" class="bg-red-700 hover:bg-red-800 text-white font-bold py-6 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <span class="text-2xl">Shito Production Mgt.</span>
            </button>
        </div>
    </div>

    <!-- === SHITO SUB-MENU PAGE === -->
    <div id="page-shito-menu" class="page container mx-auto p-4 max-w-xl text-center">
        <header class="bg-white shadow-lg rounded-xl p-6 mb-8 border-t-4 border-red-700">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold text-red-800">Shito Management</h1>
                <button onclick="showPage('page-home')" class="text-sm text-red-700 hover:underline">&larr; Back to Home</button>
            </div>
            <p class="text-gray-500">Select a Shito process to log</p>
        </header>
        <div class="grid grid-cols-1 gap-6">
            <button onclick="showPage('page-shito-batch-add')" class="bg-red-600 hover:bg-red-700 text-white font-bold py-6 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <span class="text-2xl">Batch Addition</span>
            </button>
            <button onclick="requestAccess('shitoCooking')" class="bg-gray-700 hover:bg-gray-800 text-white font-bold py-6 px-8 rounded-lg shadow-md transition-transform transform hover:scale-105">
                <span class="text-2xl">Cooking Process Control</span>
            </button>
        </div>
    </div>

    <!-- === SLURRY PAGE (truncated in this snippet to save space)... === -->
    <!-- (All the other page markup remains identical to your original file.
         For brevity in the chat, assume the HTML above earlier is unchanged.) -->

    <!-- Datalist for batch number suggestions -->
    <datalist id="batch-suggestions"></datalist>

    <!-- === COMPLETE JAVASCRIPT === -->
    <script>
    const { jsPDF } = window.jspdf;

    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. CONFIGURATION & STATE ---
        const GOOGLE_SCRIPT_URL_SLURRY = 'https://script.google.com/macros/s/AKfycbwEz9bz3P2Z5fSYgmQcvuv2j4fDCErygGSBzzpZThmN20iOQWbJInE86aXgohOfg3f1hA/exec';
        const GOOGLE_SCRIPT_URL_SHITO_BATCH = 'https://script.google.com/macros/s/AKfycbw-ZHeruo5GEdjn96iTCb1Gj8p-SPNRUtSx2LU-HKUxDzUiioJLEcM0HWjBc7rEvsGm/exec'; 
        const GOOGLE_SCRIPT_URL_SHITO_COOKING = 'https://script.google.com/macros/s/AKfycbykcdMJFjbB3uL05BVqwumwQg-yZ6eubPw5kQqIHjEuG2pgu5xZXenC2RuxIZeJaf6nOw/exec';

        const MODULE_PASSWORDS = {
            slurry: "GB",
            shitoMenu: "DIDI",
            shitoCooking: "DIDI shito"
        };

        let currentShiftInfo = {};
        let savedSlurryBatches = [];
        let savedShitoBatchLogs = [];
        let savedShitoCookingLogs = [];
        let enteredBatchNumbers = new Set();
        let chartInstances = {}; // To store and destroy chart instances

        const isMobile = /MOBI/i.test(window.navigator.userAgent);

        const appData = {
            productionLines: ['Can Line', 'SUP Line', 'Sachet Line'],
            // ... (recipes truncated here for brevity - identical to your original file)
            slurryRecipes: {/* ... */},
            shitoRecipes: {/* ... */}
        };

        // create hidden iframe early to ensure it's present for submissions
        (function ensureHiddenIframe() {
            if (!document.getElementsByName('hidden-iframe')[0]) {
                const iframe = document.createElement('iframe');
                iframe.name = 'hidden-iframe';
                iframe.style.display = 'none';
                document.body.appendChild(iframe);
            }
        })();

        // --- Utility functions (unchanged) ---
        window.showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            const pageToShow = document.getElementById(pageId);
            if (pageToShow) pageToShow.style.display = 'block';
            updateDateTime();
        };

        window.requestAccess = (moduleType) => {
            const password = prompt(`Enter Access Code for ${moduleType.replace('shito', 'Shito ').replace('Menu', ' Menu').replace('Cooking', ' Cooking')}:`);
            if (password === MODULE_PASSWORDS[moduleType]) {
                if (moduleType === 'shitoMenu') showPage('page-shito-menu');
                else if (moduleType === 'slurry') showPage('page-slurry');
                else if (moduleType === 'shitoCooking') showPage('page-shito-cooking');
            } else if (password !== null) {
                showAlert("Access Denied", "The access code you entered is incorrect.");
            }
        };

        const saveState = () => {
            try {
                const appState = {
                    slurryBatches: savedSlurryBatches,
                    shitoBatchLogs: savedShitoBatchLogs,
                    shitoCookingLogs: savedShitoCookingLogs,
                    batchNumbers: Array.from(enteredBatchNumbers),
                    timestamp: Date.now()
                };
                localStorage.setItem('productionLogState', JSON.stringify(appState));
            } catch (e) {
                console.error("Failed to save state:", e);
                showAlert("Save Error", "Could not save data. Your device storage might be full.");
            }
        };

        const loadState = () => {
            const savedState = localStorage.getItem('productionLogState');
            if (!savedState) return;
            try {
                const appState = JSON.parse(savedState);
                const now = Date.now();
                const TWENTY_FOUR_HOURS = 24 * 60 * 60 * 1000;
                if ((now - appState.timestamp) > TWENTY_FOUR_HOURS) {
                    localStorage.removeItem('productionLogState');
                    return;
                }
                savedSlurryBatches = appState.slurryBatches || [];
                savedShitoBatchLogs = appState.shitoBatchLogs || [];
                savedShitoCookingLogs = appState.shitoCookingLogs || [];
                enteredBatchNumbers = new Set(appState.batchNumbers || []);
                updateBatchSuggestions();
            } catch (e) {
                console.error("Failed to load saved state:", e);
                localStorage.removeItem('productionLogState');
            }
        };

        const getShiftInfo = () => {
            const hours = new Date().getUTCHours();
            if (hours >= 6 && hours < 14) return { shift: 'Morning', key: 'SHa' };
            if (hours >= 14 && hours < 22) return { shift: 'Afternoon', key: 'SHb' };
            return { shift: 'Night', key: 'SHc' };
        };

        const updateDateTime = () => {
            const now = new Date();
            const dateString = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            currentShiftInfo = getShiftInfo();
            const shiftString = `${currentShiftInfo.shift} (${currentShiftInfo.key})`;
            ['current-date-slurry', 'current-date-shito-batch', 'current-date-shito-cooking'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = dateString;
            });
            ['current-shift-slurry', 'current-shift-shito-batch', 'current-shift-shito-cooking'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = shiftString;
            });
        };

        const showAlert = (title, message) => {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-modal').classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        };

        const formatTimeDiff = (start, end) => {
            if (!start || !end) return "00:00";
            const s = new Date(`1970-01-01T${start}:00Z`);
            const e = new Date(`1970-01-01T${end}:00Z`);
            let diff = (e.getTime() - s.getTime()) / 60000; // minutes
            if (diff < 0) diff += 1440;
            const hours = Math.floor(diff / 60);
            const minutes = Math.round(diff % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };

        const updateBatchSuggestions = (newBatchNumber = null) => {
            if (newBatchNumber && newBatchNumber.trim() !== '') enteredBatchNumbers.add(newBatchNumber.trim());
            const datalist = document.getElementById('batch-suggestions');
            if (!datalist) return;
            datalist.innerHTML = '';
            enteredBatchNumbers.forEach(num => {
                const option = document.createElement('option');
                option.value = num;
                datalist.appendChild(option);
            });
            if (newBatchNumber) saveState();
        };

        const addBatchInputListener = (input) => {
            input.setAttribute('list', 'batch-suggestions');
            input.addEventListener('change', (e) => updateBatchSuggestions(e.target.value));
        };

        // --- Robust submitDataToGoogle (new: fetch first, fallback to form+iframe) ---
        const submitDataToGoogle = async (url, password, batchId, batchData, localCache, tableRenderer) => {
            // set local status to syncing (already done by callers), but ensure we reflect any changes:
            const batchToUpdateInit = localCache.find(b => b.id === batchId);
            if (batchToUpdateInit) batchToUpdateInit.syncStatus = 'syncing';
            tableRenderer();
            saveState();

            const payload = { password: password, rowData: batchData };

            // Helper to mark result and update UI/state
            const markResult = (status, details = '') => {
                const batchToUpdate = localCache.find(b => b.id === batchId);
                if (batchToUpdate) {
                    if (status === 'success') batchToUpdate.syncStatus = 'success';
                    else {
                        batchToUpdate.syncStatus = 'error';
                        batchToUpdate.syncError = details || 'Unknown error';
                    }
                    tableRenderer();
                    saveState();
                }
            };

            // 1) Try fetch() (preferred). This gives clearer errors when network/CORS fails.
            try {
                // attempt JSON POST
                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    // no credentials - Google Apps Script web apps usually expect POST without Authorization
                });

                if (resp.ok) {
                    // server responded 200..299
                    console.info('submitDataToGoogle: fetch succeeded for batch', batchId);
                    markResult('success');
                    return;
                } else {
                    // server responded but not OK (e.g., 4xx/5xx) — capture text for diagnostics
                    let text;
                    try { text = await resp.text(); } catch (e) { text = 'No response body'; }
                    console.warn('submitDataToGoogle: fetch returned non-ok response', resp.status, text);
                    // fall through to fallback mechanism (form+iframe)
                }
            } catch (fetchErr) {
                // fetch failed — this is likely the "Failed to fetch" error you saw in console.
                console.warn('submitDataToGoogle: fetch() failed, falling back to iframe form POST. Error:', fetchErr);
                // keep going to fallback
            }

            // 2) Fallback: form POST to hidden iframe (your original approach)
            try {
                const iframe = document.getElementsByName('hidden-iframe')[0];
                if (!iframe) throw new Error('hidden iframe not present');

                const hiddenForm = document.createElement('form');
                hiddenForm.method = 'post';
                hiddenForm.action = url;
                hiddenForm.target = 'hidden-iframe';

                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'postData';
                input.value = JSON.stringify(payload);
                hiddenForm.appendChild(input);
                document.body.appendChild(hiddenForm);

                let handled = false;
                const finish = (status, details = '') => {
                    if (handled) return;
                    handled = true;
                    try { if (document.body.contains(hiddenForm)) document.body.removeChild(hiddenForm); } catch (e) { /* ignore */ }
                    markResult(status, details);
                    iframe.onload = null;
                    iframe.onerror = null;
                };

                // Attach listeners. Note: iframe.onerror is not always fired cross-origin, but we keep it as extra guard.
                iframe.onload = () => {
                    console.info('submitDataToGoogle: iframe onload fired for batch', batchId);
                    finish('success');
                };
                iframe.onerror = (e) => {
                    console.error('submitDataToGoogle: iframe.onerror for batch', batchId, e);
                    finish('error', 'iframe load error');
                };

                // Submit the hidden form — this will navigate the iframe
                hiddenForm.submit();

                // Timeout guard — if nothing responds within 12s, mark as error
                setTimeout(() => {
                    if (!handled) {
                        console.warn('submitDataToGoogle: submission timed out for batch', batchId);
                        finish('error', 'timeout (no response)');
                    }
                }, 12000);

            } catch (iframeErr) {
                console.error('submitDataToGoogle: iframe submission failed:', iframeErr);
                markResult('error', iframeErr.message || String(iframeErr));
            }
        };

        // --- The rest of your modules and functions (unchanged) ---
        // For brevity in this reply, I did not paste your entire app again.
        // Your original functions like buildSlurryModal(), populateSlurryIngredients(),
        // handleSlurryFormSubmit(), renderSlurryTable(), buildShitoBatchModal(),
        // handleShitoBatchFormSubmit(), renderShitoBatchTable(), buildShitoCookingModal(),
        // handleShitoCookingFormSubmit(), renderShitoCookingTable(), exportBatch()
        // remain exactly as in your file except we now reference the new submitDataToGoogle above.

        // --- 5. EVENT LISTENERS & INITIALIZE ---
        function setupEventListeners() {
            // attach listeners as in your original file...
            // (Make sure the DOM elements exist — your original code already does this.)
            try {
                document.getElementById('add-entry-btn-slurry').addEventListener('click', buildSlurryModal);
                document.getElementById('form-slurry').addEventListener('submit', handleSlurryFormSubmit);
            } catch (e) { /* if form not present yet, your original init will handle it */ }

            // repeat for other listeners exactly as in your original file
            // ...
        }

        function initializeApp() {
            loadState();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            setupEventListeners();
            // hidden iframe already created at top; render local tables:
            try { renderSlurryTable(); renderShitoBatchTable(); renderShitoCookingTable(); } catch (e) { console.warn('render failed at init:', e); }
            showPage('page-home');
        }

        // call initialize (keeps behavior identical)
        initializeApp();
    });
    </script>
</body>
</html>
