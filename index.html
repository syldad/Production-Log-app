<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Log v16.1 (Recursion Fixed)</title>
    
    <!-- PWA / Full-Screen Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F97316">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FFF8F0; }
        .modal { transition: opacity 0.3s ease; }
        .table-cell { padding: 10px; border-bottom: 1px solid #F3E8DB; }
        html { overflow-y: scroll; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #FFF8F0; }
        ::-webkit-scrollbar-thumb { background: #FDBA74; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #FB923C; }
        :focus-visible { outline: 2px solid #F97316; outline-offset: 2px; border-radius: 4px; }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
            border: 1px solid transparent;
        }
        .btn-primary { background-color: #F97316; color: white; border-color: #F97316; }
        .btn-primary:hover { background-color: #EA580C; border-color: #EA580C; }
        .btn-secondary { background-color: #FED7AA; color: #9A3412; border-color: #FED7AA; }
        .btn-secondary:hover { background-color: #FDBA74; }
        .btn-danger { background-color: #DC2626; color: white; border-color: #DC2626; }
        .btn-danger:hover { background-color: #B91C1C; }
        .btn-outline { background-color: white; color: #EA580C; border-color: #FDBA74; }
        .btn-outline:hover { background-color: #FFF8F0; }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #FDBA74;
            border-radius: 8px;
            background-color: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-input:focus {
            border-color: #F97316;
            box-shadow: 0 0 0 2px #FDBA74;
            outline: none;
        }
        #custom-alert {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #custom-alert.show {
            opacity: 1;
            pointer-events: auto;
        }
        .alert-box {
            background-color: white;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        #custom-alert.show .alert-box {
            transform: scale(1);
        }
        .page-content {
            display: none; /* All pages hidden by default */
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Global App Container -->
    <div class="container mx-auto max-w-7xl p-4">

        <!-- Header - This is the main navigation -->
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <h1 class="text-3xl font-bold text-orange-600">Production Log v16.1</h1>
                <div class="flex space-x-2">
                    <!-- These buttons now control the page navigation -->
                    <button id="btn-nav-home" class="btn btn-primary">Home</button>
                    <button id="btn-nav-summary" class="btn btn-secondary">Summary</button>
                </div>
            </div>
            
            <!-- Navigation Bar from winner.txt -->
            <nav class="mt-6 bg-white rounded-lg shadow-md overflow-x-auto">
                <div class="flex justify-center space-x-4 p-4">
                    <button id="btn-nav-slurry" class="btn btn-outline flex-1">Slurry Logs</button>
                    <button id="btn-nav-shito-batch" class="btn btn-outline flex-1">Shito Batch Logs</button>
                    <button id="btn-nav-shito-cooking" class="btn btn-outline flex-1">Shito Cooking Logs</button>
                </div>
            </nav>
        </header>

        <!-- Main Content Area -->
        <main>

            <!-- Page: Home (from winner.txt) -->
            <div id="page-home" class="page-content">
                <h2 class="text-2xl font-semibold mb-4 text-orange-600">Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button id="btn-open-slurry" class="btn btn-primary h-24 text-xl">New Slurry Batch</button>
                    <button id="btn-open-shito-batch" class="btn btn-primary h-24 text-xl">New Shito Batch</button>
                    <button id="btn-open-shito-cooking" class="btn btn-primary h-24 text-xl">New Shito Cooking Log</button>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold mb-2">Welcome!</h3>
                    <p class="text-gray-700">Select an action above to create a new log, or use the navigation bar to view existing logs.</p>
                </div>
            </div>

            <!-- Page: Slurry Logs -->
            <div id="page-slurry-log" class="page-content">
                <!-- Typo Fix: class_id="tab-slurry" -> id="tab-slurry" -->
                <div id="tab-slurry" class="tab-content bg-white rounded-lg shadow-md overflow-x-auto">
                    <div class="p-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
                        <h2 class="text-xl font-semibold">Slurry Batch Records</h2>
                        <input type="text" id="search-slurry" class="form-input w-full sm:w-1/3" placeholder="Search by batch, product...">
                    </div>
                    <table class="min-w-full">
                        <thead class="bg-orange-50">
                            <tr>
                                <th class="table-cell text-left font-medium">Date</th>
                                <th class="table-cell text-left font-medium">Batch #</th>
                                <th class="table-cell text-left font-medium">Product</th>
                                <th class="table-cell text-left font-medium">Line</th>
                                <th class="table-cell text-left font-medium">Brix</th>
                                <th class="table-cell text-left font-medium">Color L</th>
                                <th class="table-cell text-left font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="slurry-table-body" class="divide-y divide-orange-100">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Shito Batch Logs -->
            <div id="page-shito-batch-log" class="page-content">
                <div id="tab-shito-batch" class="tab-content bg-white rounded-lg shadow-md overflow-x-auto">
                    <div class="p-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
                        <h2 class="text-xl font-semibold">Shito Batch Records</h2>
                        <input type="text" id="search-shito-batch" class="form-input w-full sm:w-1/3" placeholder="Search by batch, variant...">
                    </div>
                    <table class="min-w-full">
                        <thead class="bg-orange-50">
                            <tr>
                                <th class="table-cell text-left font-medium">Date</th>
                                <th class="table-cell text-left font-medium">Batch #</th>
                                <th class="table-cell text-left font-medium">Variant</th>
                                <th class="table-cell text-left font-medium">SKU</th>
                                <th class="table-cell text-left font-medium">Batch Size (T)</th>
                                <th class="table-cell text-left font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shito-batch-table-body" class="divide-y divide-orange-100">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Shito Cooking Logs -->
            <div id="page-shito-cooking-log" class="page-content">
                <div id="tab-shito-cooking" class="tab-content bg-white rounded-lg shadow-md overflow-x-auto">
                    <div class="p-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
                        <h2 class="text-xl font-semibold">Shito Cooking Records</h2>
                        <input type="text" id="search-shito-cooking" class="form-input w-full sm:w-1/3" placeholder="Search by batch ID, cycle...">
                    </div>
                    <table class="min-w-full">
                        <thead class="bg-orange-50">
                            <tr>
                                <th class="table-cell text-left font-medium">Date</th>
                                <th class="table-cell text-left font-medium">Batch ID</th>
                                <th class="table-cell text-left font-medium">Variant</th>
                                <th class="table-cell text-left font-medium">SKU</th>
                                <th class="table-cell text-left font-medium">Cooking Cycle</th>
                                <th class="table-cell text-left font-medium">Cook Total</th>
                                <th class="table-cell text-left font-medium">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="shito-cooking-table-body" class="divide-y divide-orange-100">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Page: Summary -->
            <div id="page-summary" class="page-content">
                <h2 class="text-2xl font-semibold mb-4 text-orange-600">Production Summary</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Slurry Batch Overview</h3>
                        <canvas id="slurry-chart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-3">Shito Production Overview</h3>
                        <canvas id="shito-chart"></canvas>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- ===== MODALS (from after.txt) ===== -->

    <!-- Modal: New Slurry Batch -->
    <div id="modal-slurry" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div id="modal-slurry-backdrop" class="fixed inset-0"></div>
        <div class="relative top-10 mx-auto p-6 border w-full max-w-3xl shadow-lg rounded-xl bg-white z-10">
            <h3 class="text-2xl font-semibold text-orange-600">New Slurry Batch Entry</h3>
            <form id="form-slurry" class="mt-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" name="date" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Shift</label>
                        <select name="shift" class="form-input" required>
                            <option value="">Select Shift</option>
                            <option value="SHa">SHa (Morning)</option>
                            <option value="SHb">SHb (Afternoon)</option>
                            <option value="SHc">SHc (Night)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Line</label>
                        <select name="line" class="form-input" required>
                            <option value="">Select Line</option>
                            <option value="Can Line">Can Line</option>
                            <option value="Sachet Line">Sachet Line</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Product Name</label>
                        <select name="productName" class="form-input" required>
                            <option value="">Select Product</option>
                            <option value="GINO">GINO</option>
                            <option value="POMO">POMO</option>
                            <option value="GINO / POMO">GINO / POMO</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Slurry Batch #</label>
                        <input type="text" name="slurryBatch" class="form-input" placeholder="e.g., C24001" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Mix Time (mins)</label>
                        <input type="number" step="0.1" name="mixTime" class="form-input" placeholder="e.g., 15">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Brix</label>
                        <input type="number" step="0.01" name="brix" class="form-input" placeholder="e.g., 28.5" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Color (L)</label>
                        <input type="number" step="0.01" name="colorL" class="form-input" placeholder="e.g., 23.0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Color (a/b)</label>
                        <input type="number" step="0.01" name="colorAB" class="form-input" placeholder="e.g., 2.1">
                    </div>
                </div>
                <fieldset class="border border-orange-200 p-4 rounded-lg">
                    <legend class="text-lg font-medium text-orange-600 px-2">Ingredients</legend>
                    <div id="slurry-ingredients-list" class="space-y-3">
                        <!-- Dynamic ingredient rows here -->
                    </div>
                    <button type="button" id="btn-add-slurry-ingredient" class="btn btn-secondary mt-3">+ Add Ingredient</button>
                </fieldset>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="btn-cancel-slurry" class="btn btn-outline">Cancel</button>
                    <button type="submit" id="btn-save-slurry" class="btn btn-primary">Save Slurry Batch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: New Shito Batch -->
    <div id="modal-shito-batch" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div id="modal-shito-batch-backdrop" class="fixed inset-0"></div>
        <div class="relative top-10 mx-auto p-6 border w-full max-w-3xl shadow-lg rounded-xl bg-white z-10">
            <h3 class="text-2xl font-semibold text-orange-600">New Shito Batch Entry (Pre-Cook)</h3>
            <form id="form-shito-batch" class="mt-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" name="date" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Shift</label>
                        <select name="shift" class="form-input" required>
                            <option value="">Select Shift</option>
                            <option value="SHa">SHa (Morning)</option>
                            <option value="SHb">SHb (Afternoon)</option>
                            <option value="SHc">SHc (Night)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Batch #</label>
                        <input type="text" name="batchNumber" class="form-input" placeholder="e.g., B1" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Variant</label>
                        <select name="variant" class="form-input" required>
                            <option value="">Select Variant</option>
                            <option value="HOT">HOT</option>
                            <option value="MILD">MILD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">SKU</label>
                        <select name="sku" class="form-input" required>
                            <option value="">Select SKU</option>
                            <option value="30g sachet">30g sachet</option>
                            <option value="200g Jar">200g Jar</option>
                            <option value="450g Jar">450g Jar</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Batch Size (T)</label>
                        <input type="number" step="0.01" name="batchSize" class="form-input" placeholder="e.g., 1.5">
                    </div>
                </div>
                <fieldset class="border border-orange-200 p-4 rounded-lg">
                    <legend class="text-lg font-medium text-orange-600 px-2">Ingredients</legend>
                    <div id="shito-batch-ingredients-list" class="space-y-3">
                        <!-- Dynamic ingredient rows here -->
                    </div>
                    <button type="button" id="btn-add-shito-ingredient" class="btn btn-secondary mt-3">+ Add Ingredient</button>
                </fieldset>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="btn-cancel-shito-batch" class="btn btn-outline">Cancel</button>
                    <button type="submit" id="btn-save-shito-batch" class="btn btn-primary">Save Shito Batch</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: New Shito Cooking Log -->
    <div id="modal-shito-cooking" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div id="modal-shito-cooking-backdrop" class="fixed inset-0"></div>
        <div class="relative top-10 mx-auto p-6 border w-full max-w-4xl shadow-lg rounded-xl bg-white z-10">
            <h3 class="text-2xl font-semibold text-orange-600">New Shito Cooking Log</h3>
            <form id="form-shito-cooking" class="mt-4 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Date</label>
                        <input type="date" name="date" class="form-input" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Shift</label>
                        <select name="shift" class="form-input" required>
                            <option value="">Select Shift</option>
                            <option value="SHa">SHa (Morning)</option>
                            <option value="SHb">SHb (Afternoon)</option>
                            <option value="SHc">SHc (Night)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Batch ID</label>
                        <input type="text" name="batchId" class="form-input" placeholder="e.g., B1-C1" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Variant</label>
                        <select name="variant" class="form-input" required>
                            <option value="">Select Variant</option>
                            <option value="HOT">HOT</option>
                            <option value="MILD">MILD</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">SKU</label>
                        <select name="sku" class="form-input" required>
                            <option value="">Select SKU</option>
                            <option value="30g sachet">30g sachet</option>
                            <option value="200g Jar">200g Jar</option>
                            <option value="450g Jar">450g Jar</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cooking Cycle</label>
                        <input type="text" name="cookingCycle" class="form-input" placeholder="e.g., Cycle 1" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Boule ID</label>
                        <input type="text" name="bouleId" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">GOG Start Time</label>
                        <input type="time" name="gogStart" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">GOG End Time</label>
                        <input type="time" name="gogEnd" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Batch Size (T)</label>
                        <input type="number" step="0.01" name="batchSize" class="form-input" placeholder="e.g., 1.5">
                    </div>
                </div>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Cooking Start Time</label>
                        <input type="time" name="cookStart" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Cooking End Time</label>
                        <input type="time" name="cookEnd" class="form-input">
                    </div>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Initial pH</label>
                        <input type="number" step="0.01" name="phInitial" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Final pH</label>
                        <input type="number" step="0.01" name="phFinal" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Initial Moisture</label>
                        <input type="number" step="0.01" name="moistureInitial" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Initial Temp</label>
                        <input type="number" step="0.01" name="tempInitial" class="form-input">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Initial Pressure</label>
                        <input type="number" step="0.01" name="pressureInitial" class="form-input">
                    </div>
                </div>
                <fieldset class="border border-orange-200 p-4 rounded-lg">
                    <legend class="text-lg font-medium text-orange-600 px-2">Hourly Cooking Records</legend>
                    <div id="hourly-records-list" class="space-y-3">
                        <!-- Dynamic hourly records here -->
                    </div>
                    <button type="button" id="btn-add-hourly-record" class="btn btn-secondary mt-3">+ Add Hourly Record</button>
                </fieldset>
                <div>
                    <label class="block text-sm font-medium mb-1">Comments</label>
                    <textarea name="comments" rows="3" class="form-input"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="btn-cancel-shito-cooking" class="btn btn-outline">Cancel</button>
                    <button type="submit" id="btn-save-shito-cooking" class="btn btn-primary">Save Cooking Log</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: View Log Details -->
    <div id="modal-view-log" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div id="modal-view-log-backdrop" class="fixed inset-0"></div>
        <div class="relative top-10 mx-auto p-6 border w-full max-w-3xl shadow-lg rounded-xl bg-white z-10">
            <h3 id="view-log-title" class="text-2xl font-semibold text-orange-600 mb-4">Log Details</h3>
            <div id="view-log-content" class="space-y-4">
                <!-- Content injected by JS -->
            </div>
            <div class="flex justify-end space-x-3 pt-6">
                <button type="button" id="btn-delete-log" class="btn btn-danger">Delete Log</button>
                <button type="button" id="btn-close-view-log" class="btn btn-outline">Close</button>
                <button type="button" id="btn-export-pdf" class="btn btn-primary">Export as PDF</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Box -->
    <div id="custom-alert" class="hidden">
        <div class="alert-box">
            <h4 id="alert-title" class="text-xl font-semibold mb-2">Alert</h4>
            <p id="alert-message" class="text-gray-700 mb-6">This is an alert message.</p>
            <button id="alert-ok-btn" class="btn btn-primary w-full">OK</button>
        </div>
    </div>


    <!-- Firebase App (v11.6.1) -->
    <script type="module">
        // Import Firebase services
        // RECURSION FIX: Alias the import to avoid name collision
        import { initializeApp as initializeFirebaseApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, onSnapshot, 
            query, orderBy, doc, getDoc, deleteDoc, setDoc, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================================
        // --- 1. YOUR FIREBASE CONFIG ---
        // ==========================================================
        const firebaseConfig = {
          apiKey: "AIzaSyB2jsnwvaQIJvUPLIvdWx7yS4o0xU0QOis",
          authDomain: "production-log-16c82.firebaseapp.com",
          projectId: "production-log-16c82",
          // FIX: Corrected to .appspot.com
          storageBucket: "production-log-16c82.appspot.com",
          messagingSenderId: "751331602949",
          appId: "1:751331602949:web:86843596e32483865aa26c",
          measurementId: "G-29Q2HK3SG4"
        };
        // ==========================================================
        
        // --- 2. YOUR GOOGLE APPS SCRIPT URL ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyLWIV5qR7e8JYiIfHdQioywXO_csSfjamvy7nvJr1nkf9x53IWHSMuziKBSu3iynSLnw/exec";
        // ==========================================================

        // Global variables
        let app, auth, db;
        let savedSlurryLogs = [];
        let savedShitoBatchLogs = [];
        let savedShitoCookingLogs = [];
        let slurryChart, shitoChart;
        const { jsPDF } = window.jspdf;

        // =================================================================
        // --- GLOBAL UI FUNCTIONS (Navigation, Modals, etc.) ---
        // =================================================================

        /**
         * Shows the specified page and hides all others.
         * This is the navigation logic from winner.txt.
         */
        const showPage = (pageId) => {
            document.querySelectorAll('.page-content').forEach(page => {
                page.style.display = 'none';
            });
            const page = document.getElementById(pageId);
            if (page) {
                page.style.display = 'block';
            } else {
                console.error("Page not found:", pageId);
                // Fallback to home page if specified page doesn't exist
                const homePage = document.getElementById('page-home');
                if (homePage) homePage.style.display = 'block';
            }
            
            // Special case for summary page
            if (pageId === 'page-summary') {
                initSummaryCharts();
            }
        }

        const openModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('hidden');
            }
            // Clear and pre-fill forms
            if (modalId === 'modal-slurry') {
                const list = document.getElementById('slurry-ingredients-list');
                list.innerHTML = ''; // Clear
                addSlurryIngredient("36-38% Bulk paste");
                addSlurryIngredient("Starch");
                addSlurryIngredient("Fibre");
                addSlurryIngredient("Salt");
                addSlurryIngredient("Water");
            } else if (modalId === 'modal-shito-batch') {
                const list = document.getElementById('shito-batch-ingredients-list');
                list.innerHTML = ''; // Clear
                addShitoBatchIngredient("Peeled ginger");
                addShitoBatchIngredient("Peeled onion");
                addShitoBatchIngredient("Peeled garlic");
                addShitoBatchIngredient("Tomato paste");
                addShitoBatchIngredient("Pepper");
                addShitoBatchIngredient("Nutmeg");
                addShitoBatchIngredient("Shrimp powder");
                addShitoBatchIngredient("Rosemary");
            } else if (modalId === 'modal-shito-cooking') {
                const list = document.getElementById('hourly-records-list');
                list.innerHTML = ''; // Clear
                addHourlyRecord();
            }
        }

        const closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        const showAlert = (title, message) => {
            const alertTitle = document.getElementById('alert-title');
            const alertMessage = document.getElementById('alert-message');
            const customAlert = document.getElementById('custom-alert');
            
            if(alertTitle) alertTitle.textContent = title;
            if(alertMessage) alertMessage.textContent = message;
            if(customAlert) customAlert.classList.add('show');
        }

        const addSlurryIngredient = (presetName = "") => {
            const list = document.getElementById('slurry-ingredients-list');
            if (!list) return; // Safeguard
            const index = list.children.length;
            const row = document.createElement('div');
            row.className = 'grid grid-cols-5 gap-2 items-center';
            row.innerHTML = `
                <input type="text" name="ingredient[${index}][name]" class="form-input col-span-2" placeholder="Ingredient Name" value="${presetName}" required>
                <input type="number" step="0.01" name="ingredient[${index}][qty]" class="form-input" placeholder="Qty (kg)" required>
                <input type="text" name="ingredient[${index}][batch]" class="form-input" placeholder="Batch #">
                <input type="text" name="ingredient[${index}][ratio]" class="form-input" placeholder="Ratio (e.g., 1:1)">
                <button type="button" class="btn-remove-row btn btn-danger h-10 w-10 flex-shrink-0">X</button>
            `;
            row.querySelector('.btn-remove-row').addEventListener('click', (e) => {
                e.target.closest('div.grid').remove();
            });
            list.appendChild(row);
        }

        const addShitoBatchIngredient = (presetName = "") => {
            const list = document.getElementById('shito-batch-ingredients-list');
            if (!list) return; // Safeguard
            const index = list.children.length;
            const row = document.createElement('div');
            row.className = 'grid grid-cols-4 gap-2 items-center';
            row.innerHTML = `
                <input type="text" name="ingredient[${index}][name]" class="form-input col-span-2" placeholder="Ingredient Name" value="${presetName}" required>
                <input type="number" step="0.01" name="ingredient[${index}][qty]" class="form-input" placeholder="Qty (kg)" required>
                <input type="text" name="ingredient[${index}][batch]" class="form-input" placeholder="Batch #">
                <button type="button" class="btn-remove-row btn btn-danger h-10 w-10 flex-shrink-0">X</button>
            `;
            row.querySelector('.btn-remove-row').addEventListener('click', (e) => {
                e.target.closest('div.grid').remove();
            });
            list.appendChild(row);
        }

        const addHourlyRecord = () => {
            const list = document.getElementById('hourly-records-list');
            if (!list) return; // Safeguard
            const index = list.children.length;
            const row = document.createElement('div');
            row.className = 'grid grid-cols-5 gap-2 items-center';
            row.innerHTML = `
                <input type="time" name="record[${index}][time]" class="form-input" required>
                <input type="number" step="0.01" name="record[${index}][temp]" class="form-input" placeholder="Temp (°C)" required>
                <input type="number" step="0.01" name="record[${index}][pressure]" class="form-input" placeholder="Pressure (Bar)">
                <input type="number" step="0.01" name="record[${index}][moisture]" class="form-input" placeholder="Moisture (%)">
                <button type="button" class="btn-remove-row btn btn-danger h-10 w-10 flex-shrink-0">X</button>
            `;
            row.querySelector('.btn-remove-row').addEventListener('click', (e) => {
                e.target.closest('div.grid').remove();
            });
            list.appendChild(row);
        }
        
        // =================================================================
        // --- TABLE RENDERING & VIEW DETAILS ---
        // =================================================================

        const renderSlurryTable = (searchTerm = "") => {
            const tableBody = document.getElementById('slurry-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const lowerSearch = searchTerm.toLowerCase();

            const filteredLogs = savedSlurryLogs.filter(log => {
                return (log.slurryBatch && log.slurryBatch.toLowerCase().includes(lowerSearch)) ||
                       (log.productName && log.productName.toLowerCase().includes(lowerSearch)) ||
                       (log.line && log.line.toLowerCase().includes(lowerSearch)) ||
                       (log.date && log.date.includes(lowerSearch));
            });

            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `<tr><td class="table-cell text-center" colspan="7">No matching slurry logs found.</td></tr>`;
                return;
            }

            filteredLogs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-orange-50 cursor-pointer';
                tr.innerHTML = `
                    <td class="table-cell">${log.date}</td>
                    <td class="table-cell font-medium text-orange-700">${log.slurryBatch}</td>
                    <td class="table-cell">${log.productName}</td>
                    <td class="table-cell">${log.line}</td>
                    <td class="table-cell">${log.brix || 'N/A'}</td>
                    <td class="table-cell">${log.colorL || 'N/A'}</td>
                    <td class="table-cell"><button class="btn btn-outline text-sm py-1 px-3">View</button></td>
                `;
                tr.addEventListener('click', () => viewLogDetails('slurry', log.id));
                tableBody.appendChild(tr);
            });
        }

        const renderShitoBatchTable = (searchTerm = "") => {
            const tableBody = document.getElementById('shito-batch-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const lowerSearch = searchTerm.toLowerCase();

            const filteredLogs = savedShitoBatchLogs.filter(log => {
                return (log.batchNumber && log.batchNumber.toLowerCase().includes(lowerSearch)) ||
                       (log.variant && log.variant.toLowerCase().includes(lowerSearch)) ||
                       (log.sku && log.sku.toLowerCase().includes(lowerSearch)) ||
                       (log.date && log.date.includes(lowerSearch));
            });

            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `<tr><td class="table-cell text-center" colspan="6">No matching shito batch logs found.</td></tr>`;
                return;
            }

            filteredLogs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-orange-50 cursor-pointer';
                tr.innerHTML = `
                    <td class="table-cell">${log.date}</td>
                    <td class="table-cell font-medium text-orange-700">${log.batchNumber}</td>
                    <td class="table-cell">${log.variant}</td>
                    <td class="table-cell">${log.sku}</td>
                    <td class="table-cell">${log.batchSize || 'N/A'}</td>
                    <td class="table-cell"><button class="btn btn-outline text-sm py-1 px-3">View</button></td>
                `;
                tr.addEventListener('click', () => viewLogDetails('shitoBatch', log.id));
                tableBody.appendChild(tr);
            });
        }

        const renderShitoCookingTable = (searchTerm = "") => {
            const tableBody = document.getElementById('shito-cooking-table-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const lowerSearch = searchTerm.toLowerCase();

            const filteredLogs = savedShitoCookingLogs.filter(log => {
                return (log.batchId && log.batchId.toLowerCase().includes(lowerSearch)) ||
                       (log.cookingCycle && log.cookingCycle.toLowerCase().includes(lowerSearch)) ||
                       (log.variant && log.variant.toLowerCase().includes(lowerSearch)) ||
                       (log.sku && log.sku.toLowerCase().includes(lowerSearch)) ||
                       (log.date && log.date.includes(lowerSearch));
            });

            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `<tr><td class="table-cell text-center" colspan="7">No matching shito cooking logs found.</td></tr>`;
                return;
            }

            filteredLogs.forEach(log => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-orange-50 cursor-pointer';
                tr.innerHTML = `
                    <td class="table-cell">${log.date}</td>
                    <td class="table-cell font-medium text-orange-700">${log.batchId}</td>
                    <td class="table-cell">${log.variant}</td>
                    <td class="table-cell">${log.sku}</td>
                    <td class="table-cell">${log.cookingCycle}</td>
                    <td class="table-cell">${log.cookTotal || 'N/A'}</td>
                    <td class="table-cell"><button class="btn btn-outline text-sm py-1 px-3">View</button></td>
                `;
                tr.addEventListener('click', () => viewLogDetails('shitoCooking', log.id));
                tableBody.appendChild(tr);
            });
        }
        
        const viewLogDetails = (logType, id) => {
            let log, title;
            let contentHtml = '';
            let collectionName = '';

            const detailRow = (label, value) => {
                if (!value || value === 'N/A') return ''; 
                return `<div class="grid grid-cols-3 gap-4">
                            <span class="font-medium text-gray-600 col-span-1">${label}</span>
                            <span class="text-gray-800 col-span-2">${value}</span>
                        </div>`;
            };

            const buildTable = (headers, data) => {
                if (!data || data.length === 0) return '<p>No records found.</p>';
                let table = '<div class="overflow-x-auto rounded-lg border border-orange-200 mt-2"><table class="min-w-full divide-y divide-orange-200">';
                table += '<thead class="bg-orange-50"><tr class="text-left">';
                headers.forEach(h => table += `<th class="table-cell text-sm font-medium">${h}</th>`);
                table += '</tr></thead><tbody class="bg-white divide-y divide-orange-100">';
                
                data.forEach(row => {
                    table += '<tr>';
                    headers.forEach(h => {
                        const key = h.toLowerCase().replace(' #', '').replace(' (kg)', '').replace(' (°c)', '').replace(' (bar)', '').replace(' (%)', '');
                        table += `<td class="table-cell text-sm">${row[key] || 'N/A'}</td>`;
                    });
                    table += '</tr>';
                });
                
                table += '</tbody></table></div>';
                return table;
            };

            if (logType === 'slurry') {
                log = savedSlurryLogs.find(l => l.id === id);
                if (!log) return;
                title = `Slurry Batch: ${log.slurryBatch}`;
                collectionName = 'slurryBatches';
                contentHtml = `
                    <div id="pdf-export-content" class="space-y-3">
                        ${detailRow('Date', log.date)}
                        ${detailRow('Time Saved', log.timeSaved)}
                        ${detailRow('Shift', log.shift)}
                        ${detailRow('Line', log.line)}
                        ${detailRow('Product', log.productName)}
                        <hr class="border-orange-100">
                        ${detailRow('Mix Time', log.mixTime ? `${log.mixTime} mins` : 'N/A')}
                        ${detailRow('Brix', log.brix)}
                        ${detailRow('Color (L)', log.colorL)}
                        ${detailRow('Color (a/b)', log.colorAB)}
                        <hr class="border-orange-100">
                        <h4 class="text-lg font-semibold text-orange-600 mt-2">Ingredients</h4>
                        ${buildTable(['Name', 'Qty (kg)', 'Batch #', 'Ratio'], log.ingredients)}
                    </div>
                `;
            } else if (logType === 'shitoBatch') {
                log = savedShitoBatchLogs.find(l => l.id === id);
                if (!log) return;
                title = `Shito Batch: ${log.batchNumber}`;
                collectionName = 'shitoBatchLogs';
                contentHtml = `
                    <div id="pdf-export-content" class="space-y-3">
                        ${detailRow('Date', log.date)}
                        ${detailRow('Time Saved', log.timeSaved)}
                        ${detailRow('Shift', log.shift)}
                        ${detailRow('Variant', log.variant)}
                        ${detailRow('SKU', log.sku)}
                        ${detailRow('Batch Size (T)', log.batchSize)}
                        <hr class="border-orange-100">
                        <h4 class="text-lg font-semibold text-orange-600 mt-2">Ingredients</h4>
                        ${buildTable(['Name', 'Qty (kg)', 'Batch #'], log.ingredients)}
                    </div>
                `;
            } else if (logType === 'shitoCooking') {
                log = savedShitoCookingLogs.find(l => l.id === id);
                if (!log) return;
                title = `Shito Cooking: ${log.batchId}`;
                collectionName = 'shitoCookingLogs';
                contentHtml = `
                    <div id="pdf-export-content" class="space-y-3">
                        ${detailRow('Date', log.date)}
                        ${detailRow('Time Saved', log.timeSaved)}
                        ${detailRow('Shift', log.shift)}
                        ${detailRow('Variant', log.variant)}
                        ${detailRow('SKU', log.sku)}
                        ${detailRow('Cooking Cycle', log.cookingCycle)}
                        ${detailRow('Boule ID', log.bouleId)}
                        ${detailRow('Batch Size (T)', log.batchSize)}
                        <hr class="border-orange-100">
                        <h4 class="text-md font-semibold text-orange-600">GOG</h4>
                        ${detailRow('Start', log.gogStart)}
                        ${detailRow('End', log.gogEnd)}
                        ${detailRow('Total', log.gogTotal)}
                        <h4 class="text-md font-semibold text-orange-600 mt-2">Cooking</h4>
                        ${detailRow('Start', log.cookStart)}
                        ${detailRow('End', log.cookEnd)}
                        ${detailRow('Total', log.cookTotal)}
                        <hr class="border-orange-100">
                        <h4 class="text-md font-semibold text-orange-600 mt-2">Quality</h4>
                        ${detailRow('Initial pH', log.phInitial)}
                        ${detailRow('Final pH', log.phFinal)}
                        ${detailRow('Initial Moisture', log.moistureInitial)}
                        ${detailRow('Initial Temp', log.tempInitial)}
                        ${detailRow('Initial Pressure', log.pressureInitial)}
                        ${detailRow('Comments', log.comments)}
                        <hr class="border-orange-100">
                        <h4 class="text-lg font-semibold text-orange-600 mt-2">Hourly Records</h4>
                        ${buildTable(['Time', 'Temp (°C)', 'Pressure (Bar)', 'Moisture (%)'], log.hourlyRecords)}
                    </div>
                `;
            }

            document.getElementById('view-log-title').textContent = title;
            document.getElementById('view-log-content').innerHTML = contentHtml;
            
            // Re-bind delete button listener
            const deleteBtn = document.getElementById('btn-delete-log');
            const newDeleteBtn = deleteBtn.cloneNode(true); // Recreate to remove old listeners
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            newDeleteBtn.addEventListener('click', async () => {
                // Using built-in confirm for simplicity. 
                if (confirm(`Are you sure you want to delete this log: ${title}? This cannot be undone.`)) {
                    try {
                        newDeleteBtn.textContent = "Deleting...";
                        newDeleteBtn.disabled = true;
                        await deleteDoc(doc(db, collectionName, id));
                        showAlert("Deleted", "Log has been deleted.");
                        closeModal('modal-view-log');
                    } catch (error) {
                        console.error("Delete failed:", error);
                        showAlert("Error", "Could not delete log. " + error.message);
                        newDeleteBtn.textContent = "Delete Log";
                        newDeleteBtn.disabled = false;
                    }
                }
            });

            // Re-bind export button listener
            const exportBtn = document.getElementById('btn-export-pdf');
            const newExportBtn = exportBtn.cloneNode(true);
            exportBtn.parentNode.replaceChild(newExportBtn, exportBtn);
            newExportBtn.addEventListener('click', () => {
                exportLogToPDF(title);
            });

            openModal('modal-view-log');
        }
        
        async function exportLogToPDF(fileName) {
            const content = document.getElementById('pdf-export-content');
            if (!content) return;
            
            const exportBtn = document.getElementById('btn-export-pdf');
            exportBtn.textContent = "Exporting...";
            exportBtn.disabled = true;

            try {
                const canvas = await html2canvas(content, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: '#ffffff'
                });
                
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({
                    orientation: 'p',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                
                const ratio = imgHeight / imgWidth;
                let newImgWidth = pdfWidth - 20; 
                let newImgHeight = newImgWidth * ratio;
                
                if (newImgHeight > pdfHeight - 20) {
                    newImgHeight = pdfHeight - 20;
                    newImgWidth = newImgHeight / ratio;
                }
                
                const x = (pdfWidth - newImgWidth) / 2; 
                const y = 10; 

                pdf.addImage(imgData, 'PNG', x, y, newImgWidth, newImgHeight);
                pdf.save(`${fileName.replace(/[\/:]/g, '-')}.pdf`);
                
            } catch (error) {
                console.error("PDF Export Failed:", error);
                showAlert("Export Failed", "Could not generate PDF. " + error.message);
            } finally {
                exportBtn.textContent = "Export as PDF";
                exportBtn.disabled = false;
            }
        }

        // =================================================================
        // --- SUMMARY CHARTS ---
        // =================================================================

        function initSummaryCharts() {
            const slurryCtx = document.getElementById('slurry-chart')?.getContext('2d');
            if (!slurryCtx) return; // Safeguard
            if (slurryChart) slurryChart.destroy();
            
            const slurryData = {
                labels: [],
                datasets: [{
                    label: 'Average Brix',
                    data: [],
                    backgroundColor: 'rgba(249, 115, 22, 0.2)',
                    borderColor: 'rgba(249, 115, 22, 1)',
                    borderWidth: 1
                }]
            };
            
            const productBrix = {}; 
            savedSlurryLogs.forEach(log => {
                if (log.productName && log.brix) {
                    if (!productBrix[log.productName]) {
                        productBrix[log.productName] = [];
                    }
                    productBrix[log.productName].push(parseFloat(log.brix));
                }
            });
            
            for (const [product, brixValues] of Object.entries(productBrix)) {
                slurryData.labels.push(product);
                const avg = brixValues.reduce((a, b) => a + b, 0) / brixValues.length;
                slurryData.datasets[0].data.push(avg.toFixed(2));
            }

            slurryChart = new Chart(slurryCtx, {
                type: 'bar',
                data: slurryData,
                options: {
                    scales: { y: { beginAtZero: false, title: { display: true, text: 'Average Brix' } } },
                    responsive: true,
                    plugins: { legend: { display: false }, title: { display: true, text: 'Average Brix by Product' } }
                }
            });
            
            const shitoCtx = document.getElementById('shito-chart')?.getContext('2d');
            if (!shitoCtx) return; // Safeguard
            if (shitoChart) shitoChart.destroy();
            
            const shitoData = {
                labels: ['HOT', 'MILD'],
                datasets: [{
                    label: 'Batch Count',
                    data: [0, 0],
                    backgroundColor: ['rgba(220, 38, 38, 0.2)', 'rgba(5, 150, 105, 0.2)'],
                    borderColor: ['rgba(220, 38, 38, 1)', 'rgba(5, 150, 105, 1)'],
                    borderWidth: 1
                }]
            };
            
            savedShitoBatchLogs.forEach(log => {
                if (log.variant === 'HOT') shitoData.datasets[0].data[0]++;
                if (log.variant === 'MILD') shitoData.datasets[0].data[1]++;
            });
            
            shitoChart = new Chart(shitoCtx, {
                type: 'pie',
                data: shitoData,
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' }, title: { display: true, text: 'Shito Batch Count by Variant' } }
                }
            });
        }
        
        // =================================================================
        // --- DATA PARSING & SAVING (From after.txt) ---
        // =================================================================
            
        function getCurrentTime() {
            return new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
        }

        function parseDynamicFields(form, fieldPrefix) {
            const data = new FormData(form);
            const items = [];
            const keys = new Set();
            
            data.forEach((value, key) => {
                if (key.startsWith(fieldPrefix)) {
                    keys.add(key);
                }
            });

            const indices = new Set();
            keys.forEach(key => {
                const match = key.match(new RegExp(`^${fieldPrefix}\\[(\\d+)\\]`));
                if (match && match[1]) {
                    indices.add(parseInt(match[1], 10));
                }
            });

            indices.forEach(index => {
                const item = {};
                const itemKeys = Array.from(keys).filter(k => k.startsWith(`${fieldPrefix}[${index}]`));
                
                itemKeys.forEach(key => {
                    const propMatch = key.match(new RegExp(`\\[(.*?)\\]$`));
                    if (propMatch && propMatch[1]) {
                        const propName = propMatch[1];
                        item[propName] = data.get(key) || null;
                    }
                });
                
                if (Object.keys(item).length > 0) {
                    if ((item.name && item.qty) || (item.time && item.temp)) {
                        items.push(item);
                    }
                }
            });
            return items;
        }

        const calculateTotalTime = (start, end) => {
            if (!start || !end) return null;
            try {
                const startTime = new Date(`1970-01-01T${start}:00`);
                const endTime = new Date(`1970-01-01T${end}:00`);
                let diff = (endTime.getTime() - startTime.getTime()) / 60000; 
                if (diff < 0) diff += 1440; 
                const hours = Math.floor(diff / 60);
                const minutes = Math.floor(diff % 60);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            } catch {
                return null;
            }
        };

        // --- FORM SUBMIT HANDLERS (Dual Save Logic) ---
        
        async function handleSlurryFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('btn-save-slurry');
            submitButton.textContent = 'Saving...';
            submitButton.disabled = true;

            try {
                const formData = new FormData(form);
                const newBatch = {
                    logType: "slurry", 
                    date: formData.get('date'),
                    timeSaved: getCurrentTime(),
                    shift: formData.get('shift'),
                    line: formData.get('line'),
                    productName: formData.get('productName'),
                    slurryBatch: formData.get('slurryBatch'),
                    mixTime: formData.get('mixTime') || null,
                    brix: formData.get('brix') || null,
                    colorL: formData.get('colorL') || null,
                    colorAB: formData.get('colorAB') || null,
                    ingredients: parseDynamicFields(form, 'ingredient'),
                    createdAt: serverTimestamp() 
                };

                console.log("Saving new slurry batch:", newBatch);

                const firestorePromise = addDoc(collection(db, "slurryBatches"), newBatch);

                const sheetsPromise = fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newBatch),
                }).then(response => {
                    if (!response.ok) throw new Error(`Google Sheets status: ${response.status}`);
                    return response.text();
                }).then(text => {
                    if (text !== 'success') throw new Error(`Google Sheets error: ${text}`);
                    return text;
                });

                await Promise.all([firestorePromise, sheetsPromise]);

                console.log("Successfully saved to both.");
                showAlert("Success", "New slurry batch saved successfully.");
                form.reset();
                setFormDefaults(form); 
                closeModal('modal-slurry');

            } catch (error) {
                console.error("Save Failed:", error);
                showAlert("Save Failed", "Could not save data. Error: " + error.message);
            } finally {
                submitButton.textContent = 'Save Slurry Batch';
                submitButton.disabled = false;
            }
        }

        async function handleShitoBatchFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('btn-save-shito-batch');
            submitButton.textContent = 'Saving...';
            submitButton.disabled = true;

            try {
                const formData = new FormData(form);
                const newBatch = {
                    logType: "shitoBatch", 
                    date: formData.get('date'),
                    timeSaved: getCurrentTime(),
                    shift: formData.get('shift'),
                    batchNumber: formData.get('batchNumber'),
                    variant: formData.get('variant'),
                    sku: formData.get('sku'),
                    batchSize: formData.get('batchSize') || null,
                    ingredients: parseDynamicFields(form, 'ingredient'),
                    createdAt: serverTimestamp() 
                };

                console.log("Saving new shito batch:", newBatch);
                
                const firestorePromise = addDoc(collection(db, "shitoBatchLogs"), newBatch);

                const sheetsPromise = fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newBatch),
                }).then(response => response.text()).then(text => {
                    if (text !== 'success') throw new Error(`Google Sheets script error: ${text}`);
                });

                await Promise.all([firestorePromise, sheetsPromise]);

                console.log("Successfully saved to both.");
                showAlert("Success", "New shito batch saved successfully.");
                form.reset();
                setFormDefaults(form); 
                closeModal('modal-shito-batch');

            } catch (error) {
                console.error("Save Failed:", error);
                showAlert("Save Failed", "Could not save data. Error: " + error.message);
            } finally {
                submitButton.textContent = 'Save Shito Batch';
                submitButton.disabled = false;
            }
        }

        async function handleShitoCookingFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const submitButton = document.getElementById('btn-save-shito-cooking');
            submitButton.textContent = 'Saving...';
            submitButton.disabled = true;

            try {
                const formData = new FormData(form);
                
                const gogStart = formData.get('gogStart') || null;
                const gogEnd = formData.get('gogEnd') || null;
                const cookStart = formData.get('cookStart') || null;
                const cookEnd = formData.get('cookEnd') || null;

                const newLog = {
                    logType: "shitoCooking", 
                    date: formData.get('date'),
                    timeSaved: getCurrentTime(),
                    shift: formData.get('shift'),
                    batchId: formData.get('batchId'),
                    variant: formData.get('variant'),
                    sku: formData.get('sku'),
                    cookingCycle: formData.get('cookingCycle'),
                    bouleId: formData.get('bouleId') || null,
                    gogStart: gogStart,
                    gogEnd: gogEnd,
                    gogTotal: calculateTotalTime(gogStart, gogEnd),
                    batchSize: formData.get('batchSize') || null,
                    cookStart: cookStart,
                    cookEnd: cookEnd,
                    cookTotal: calculateTotalTime(cookStart, cookEnd),
                    phInitial: formData.get('phInitial') || null,
                    phFinal: formData.get('phFinal') || null,
                    moistureInitial: formData.get('moistureInitial') || null,
                    tempInitial: formData.get('tempInitial') || null,
                    pressureInitial: formData.get('pressureInitial') || null,
                    comments: formData.get('comments') || null,
                    hourlyRecords: parseDynamicFields(form, 'record'),
                    createdAt: serverTimestamp() 
                };

                console.log("Saving new shito cooking log:", newLog);

                const firestorePromise = addDoc(collection(db, "shitoCookingLogs"), newLog);

                const sheetsPromise = fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newLog),
                }).then(response => response.text()).then(text => {
                    if (text !== 'success') throw new Error(`Google Sheets script error: ${text}`);
                });

                await Promise.all([firestorePromise, sheetsPromise]);

                console.log("Successfully saved to both.");
                showAlert("Success", "New shito cooking log saved successfully.");
                form.reset();
                setFormDefaults(form); 
                closeModal('modal-shito-cooking');

            } catch (error) {
                console.error("Save Failed:", error);
                showAlert("Save Failed", "Could not save data. Error: " + error.message);
            } finally {
                submitButton.textContent = 'Save Cooking Log';
                submitButton.disabled = false;
            }
        }

        // =================================================================
        // --- APP INITIALIZATION ---
        // =================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // RECURSION FIX: Renamed local function to avoid collision
            function startApp() {
                try {
                    // RECURSION FIX: Call the aliased Firebase import
                    app = initializeFirebaseApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    setLogLevel('debug'); 
                    console.log("Firebase initialized.");

                    signInAnonymously(auth)
                        .then(() => {
                            console.log("User signed in anonymously.", auth.currentUser?.uid);
                            attachDataListeners(); // Start listening for data
                        })
                        .catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            showAlert("Authentication Error", "Could not connect to the database.");
                        });
                    
                    // This is the key fix:
                    // We set up the buttons *immediately* after the page loads.
                    setupEventListeners();
                    setFormDefaults();
                    showPage('page-home'); // Show the home page on start
                    
                } catch (error) {
                    console.error("Error during app initialization:", error);
                    showAlert("Fatal Error", "App could not be initialized. Please check console for errors.");
                }
            }

            /**
             * Attaches all click/input listeners for the app.
             * This is the fix for the unresponsive buttons.
             */
            function setupEventListeners() {
                console.log("Setting up event listeners...");
                
                // Page Navigation (from winner.txt architecture)
                document.getElementById('btn-nav-home')?.addEventListener('click', () => showPage('page-home'));
                document.getElementById('btn-nav-summary')?.addEventListener('click', () => showPage('page-summary'));
                document.getElementById('btn-nav-slurry')?.addEventListener('click', () => showPage('page-slurry-log'));
                document.getElementById('btn-nav-shito-batch')?.addEventListener('click', () => showPage('page-shito-batch-log'));
                document.getElementById('btn-nav-shito-cooking')?.addEventListener('click', () => showPage('page-shito-cooking-log'));

                // Open Modals (from home page)
                document.getElementById('btn-open-slurry')?.addEventListener('click', () => openModal('modal-slurry'));
                document.getElementById('btn-open-shito-batch')?.addEventListener('click', () => openModal('modal-shito-batch'));
                document.getElementById('btn-open-shito-cooking')?.addEventListener('click', () => openModal('modal-shito-cooking'));

                // Close Modals (Cancel buttons and backdrop clicks)
                document.getElementById('btn-cancel-slurry')?.addEventListener('click', () => closeModal('modal-slurry'));
                document.getElementById('modal-slurry-backdrop')?.addEventListener('click', () => closeModal('modal-slurry'));
                
                document.getElementById('btn-cancel-shito-batch')?.addEventListener('click', () => closeModal('modal-shito-batch'));
                document.getElementById('modal-shito-batch-backdrop')?.addEventListener('click', () => closeModal('modal-shito-batch'));

                document.getElementById('btn-cancel-shito-cooking')?.addEventListener('click', () => closeModal('modal-shito-cooking'));
                document.getElementById('modal-shito-cooking-backdrop')?.addEventListener('click', () => closeModal('modal-shito-cooking'));
                
                document.getElementById('btn-close-view-log')?.addEventListener('click', () => closeModal('modal-view-log'));
                document.getElementById('modal-view-log-backdrop')?.addEventListener('click', () => closeModal('modal-view-log'));

                // Form "Add" buttons
                document.getElementById('btn-add-slurry-ingredient')?.addEventListener('click', () => addSlurryIngredient());
                document.getElementById('btn-add-shito-ingredient')?.addEventListener('click', () => addShitoBatchIngredient());
                document.getElementById('btn-add-hourly-record')?.addEventListener('click', () => addHourlyRecord());

                // Form submit handlers
                document.getElementById('form-slurry')?.addEventListener('submit', handleSlurryFormSubmit);
                document.getElementById('form-shito-batch')?.addEventListener('submit', handleShitoBatchFormSubmit);
                document.getElementById('form-shito-cooking')?.addEventListener('submit', handleShitoCookingFormSubmit);

                // Search/filter handlers
                document.getElementById('search-slurry')?.addEventListener('input', (e) => renderSlurryTable(e.target.value));
                document.getElementById('search-shito-batch')?.addEventListener('input', (e) => renderShitoBatchTable(e.target.value));
                document.getElementById('search-shito-cooking')?.addEventListener('input', (e) => renderShitoCookingTable(e.target.value));

                // Custom alert OK button
                document.getElementById('alert-ok-btn')?.addEventListener('click', () => {
                    document.getElementById('custom-alert').classList.remove('show');
                });
            }

            /**
             * Sets the default date on all forms to today.
             */
            function setFormDefaults(form) {
                const today = new Date().toISOString().split('T')[0];
                if (form) {
                    // Set date only for the form that was just reset
                    const dateInput = form.querySelector('input[name="date"]');
                    if(dateInput) dateInput.value = today;
                } else {
                    // Set date for all forms on initial load
                    document.querySelectorAll('input[name="date"]').forEach(input => input.value = today);
                }
            }

            /**
             * Attaches the real-time Firebase listeners.
             */
            function attachDataListeners() {
                if (!db) {
                    console.error("Firestore DB is not initialized. Cannot attach listeners.");
                    return;
                }
                console.log("Attaching data listeners...");

                const slurryQuery = query(collection(db, "slurryBatches"), orderBy("createdAt", "desc"));
                onSnapshot(slurryQuery, (snapshot) => {
                    savedSlurryLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const searchInput = document.getElementById('search-slurry');
                    renderSlurryTable(searchInput ? searchInput.value : "");
                    console.log("Live Slurry Batches Updated:", savedSlurryLogs.length);
                }, (error) => {
                    console.error("Error listening to slurry batches:", error);
                    showAlert("Connection Error", "Could not load slurry data.");
                });

                const shitoBatchQuery = query(collection(db, "shitoBatchLogs"), orderBy("createdAt", "desc"));
                onSnapshot(shitoBatchQuery, (snapshot) => {
                    savedShitoBatchLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const searchInput = document.getElementById('search-shito-batch');
                    renderShitoBatchTable(searchInput ? searchInput.value : "");
                    console.log("Live Shito Batches Updated:", savedShitoBatchLogs.length);
                }, (error) => {
                    console.error("Error listening to shito batches:", error);
                    showAlert("Connection Error", "Could not load shito batch data.");
                });

                const shitoCookingQuery = query(collection(db, "shitoCookingLogs"), orderBy("createdAt", "desc"));
                onSnapshot(shitoCookingQuery, (snapshot) => {
                    savedShitoCookingLogs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const searchInput = document.getElementById('search-shito-cooking');
                    renderShitoCookingTable(searchInput ? searchInput.value : "");
                    console.log("Live Shito Cooking Logs Updated:", savedShitoCookingLogs.length);
                }, (error) => {
                    console.error("Error listening to shito cooking logs:", error);
                    showAlert("Connection Error", "Could not load shito cooking data.");
                });
            }

            // --- START THE APP ---
            // RECURSION FIX: Call the renamed local function
            startApp();
        });
    </script>
</body>
</html>

